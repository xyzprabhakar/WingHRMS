@page
@{
    ViewData["PageId"] = "200105";
    ViewData["Title"] = "Customer Markup Report";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}
    <div class="col-md-12">
        <div class="panel">
            <div class="card">
                <div class="card-body p-2">
                    <div class="form-container master-panel">
                        <div class="col-md-12">
                            <h4> @ViewBag.Title </h4>
                            <hr />
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-form-label col-md-3">Filter Type</label>
                                    <div class="col-md-8">
                                        <div class="form-check-inline my-1">
                                            <div class="custom-control custom-radio">
                                                <input class="custom-control-input" id="chk_BookingDt" type="radio" value="true" name="chk_BookingDt" checked>
                                                <label class="custom-control-label" for="chk_BookingDt">  On Booking Dt</label>
                                            </div>
                                        </div>
                                        <div class="form-check-inline my-1">
                                            <div class="custom-control custom-radio">
                                                <input class="custom-control-input" id="chk_TravelDt" type="radio" value="false" name="chk_TravelDt" >
                                                <label class="custom-control-label" for="chk_TravelDt">  On Travel Dt</label>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <div class="form-group" for="txtEffectiveFromDt">
                                        <label class="col-form-label col-md-4" for="txtEffectiveFromDt">Effective From</label>
                                        <div class="col-md-8">
                                            <input type="text" id="txtEffectiveFromDt" name="txtEffectiveFromDt"
                                                   maxlength="256" autocomplete="off"
                                                   class="form-control ip-ap" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group" for="txtEffectiveToDt">
                                        <label class="col-form-label col-md-4" for="txtEffectiveToDt">Effective To</label>
                                        <div class="col-md-8">
                                            <input type="text" id="txtEffectiveToDt" name="txtEffectiveToDt"
                                                   maxlength="256" autocomplete="off"
                                                   class="form-control ip-ap" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <input type="button" id="loadGridData" class="btn btn-primary btn-lg" value="Get Data">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <hr />
                                <div class="table-responsive no-margin">
                                    <table id="dt_table1" class="table w-100 no-margin table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Applicability</th>
                                                <th>ServiceProviders</th>
                                                <th>CustomerTypes</th>
                                                <th>CustomerCode</th>
                                                <th>PassengerType</th>
                                                <th>Airline</th>
                                                <th>Segments</th>
                                                <th>CabinClass</th>
                                                <th>IsMLMIncentive</th>
                                                <th>FlightType</th>
                                                <th>Gender</th>
                                                <th>Is Percentage</th>
                                                <th>Percentage Value</th>
                                                <th>Amount Caping</th>
                                                <th>Amount</th>
                                                <th>Travel FromDt</th>
                                                <th>Travel ToDt</th>
                                                <th>Booking FromDt</th>
                                                <th>Booking ToDt</th>
                                                <th>Created By</th>
                                                <th>Created Dt</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                    <div class="clear"></div>
                                </div>
                            </div>


                        </div>
                    </div>
            </div>
        </div>
    </div>

@section Scripts {    
    <script type="text/javascript">

        $(document).ready(function () {
            let OrgId = localStorage.getItem("currentOrganisation");
            let token = localStorage.getItem('token');
            let headerss = new Headers();

            $(".ip-ap").flatpickr({
                dateFormat: "d-M-Y",
            });

            $("#txtEffectiveFromDt").val(GetDateFormatddMMyyyy(new Date()));
            $("#txtEffectiveToDt").val(GetDateFormatddMMyyyy(new Date()));

            headerss.append("Authorization", 'Bearer ' + token);
            headerss.append("Content-Type", "application/json; charset=utf-8");
            headerss.append("OrgId", OrgId);
            //bindcountry
            $("#loadGridData").click(function () {
                $('#loader').show();
                let chk_BookingDt = $("#chk_BookingDt").prop('checked');
                let fromDt = $("#txtEffectiveFromDt").val();
                let toDt = $("#txtEffectiveToDt").val();
                
                let apiurl = localStorage.getItem('baseUrl') + "/Air/Markups/GetWingMarkup/" + chk_BookingDt + "/" + fromDt + "/" + toDt ;
                fetch(apiurl, {
                    method: "GET",
                    headers: headerss,
                }).then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(response.statusText);
                    }
                }).then(data => {
                    if (data.messageType == 1) {
                        var dt = $("#dt_table1").DataTable({
                            "processing": true, // for show progress bar
                            "serverSide": false, // for process server side
                            responsive: true,
                            "bDestroy": true,
                            "filter": true, // this is for disable filter (search box)
                            "orderMulti": false, // for disable multiple column at once
                            "scrollX": 200,
                            //"scrollY": "200px",
                            //dom: 'lBfrtip',
                            dom: "<'row'<'col-md-12 text-right mb-3'B>><'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                            buttons: [
                                {
                                    text: 'Export',
                                    title: 'Company Data',
                                    extend: 'excelHtml5',
                                    exportOptions: {
                                        columns: [0,1, 2, 3, 4, 5, 6, 7,8,9,10,11,12,13,14,15,16,17,18,19,20]
                                    }
                                },
                                {
                                    extend: 'colvis',
                                    columnText: function (dt, idx, title) {
                                        return (idx + 1) + ': ' + title;
                                    }
                                }
                            ],
                            "aaData": data.returnId,
                            "columnDefs":
                                [{
                                    targets: [8,11],
                                    "class": "text-center",
                                    render: function (data, type, row) {
                                        return data == 1 ? `<spam class="badge badge-success">Yes</spam>` : '<spam class="badge badge-danger">No</spam>'
                                        
                                    }
                                }
                                    ,{
                                        targets: [15,16,17,18],
                                        render: function (data, type, row) {
                                            var date = new Date(data);
                                            return GetDateFormatddMMyyyy(date);
                                        }
                                    }, {
                                        targets: [20],
                                        render: function (data, type, row) {
                                            var date = new Date(data);
                                            return GetDateFormatddMMyyyyHHtt(date);
                                        }
                                    },
                                    {
                                        targets: [21],
                                        "class": "text-center",
                                        render: function (data, type, row) {
                                            return `<a class="dropdown-item" href="#"  data-delete-id="${data}" onClick=fncDeleteGridData(this) > <i class="fa fa-trash-alt"></i> Delete</a>`;
                                        }
                                    }
                                ],
                            "columns": [
                                { "data": "applicability", "name": "applicability", "autoWidth": true },
                                { "data": "serviceProviders", "name": "serviceProviders", "autoWidth": true },
                                { "data": "customerTypes", "name": "customerTypes", "autoWidth": true },
                                { "data": "customerCode", "name": "customerCode", "autoWidth": true },
                                { "data": "passengerType", "name": "passengerType", "autoWidth": true },
                                { "data": "airline", "name": "airline", "autoWidth": true },
                                { "data": "segments", "name": "segments", "autoWidth": true },
                                { "data": "cabinClass", "name": "cabinClass", "autoWidth": true },
                                { "data": "isMLMIncentive", "name": "isMLMIncentive", "autoWidth": true },
                                { "data": "flightType", "name": "flightType", "autoWidth": true },
                                { "data": "gender", "name": "gender", "autoWidth": true },
                                { "data": "isPercentage", "name": "isPercentage", "autoWidth": true },
                                { "data": "percentageValue", "name": "percentageValue", "autoWidth": true },
                                { "data": "amountCaping", "name": "amountCaping", "autoWidth": true },
                                { "data": "amount", "name": "amount", "autoWidth": true },
                                { "data": "travelFromDt", "name": "travelFromDt", "autoWidth": true },
                                { "data": "travelToDt", "name": "travelToDt", "autoWidth": true },
                                { "data": "bookingFromDt", "name": "bookingFromDt", "autoWidth": true },
                                { "data": "bookingToDt", "name": "bookingToDt", "autoWidth": true },
                                { "data": "createdByName", "name": "createdByName", "autoWidth": true },
                                { "data": "createdDt", "name": "createdDt", "autoWidth": true },
                                { "data": "id", "name": "id", "autoWidth": true }
                            ],
                            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
                            
                        });

                        $('#loader').hide();
                    }
                    else {
                        $('#loader').hide();
                        messageBox("error", data.message);
                    }
                }).catch((error) => {
                    $('#loader').hide();
                    messageBox("error", error.message);
                });

            });
        });


        function fncDeleteGridData(e) {
            let OrgId = localStorage.getItem("currentOrganisation");
            let token = localStorage.getItem('token');
            let headerss = new Headers();
            headerss.append("Authorization", 'Bearer ' + token);
            headerss.append("Content-Type", "application/json; charset=utf-8");
            headerss.append("OrgId", OrgId);
            msgBoxImagePath = "/js/msgbox/images/";
            $.msgBox({
                title: "Remarks",
                content: "Please enter the remarks",
                type: "prompt",
                buttons: [{ value: "OK" }, { value: "Cancel" }],
                inputs: [{ type: "text", name: "txtDeletedRemarks", header: "Remarks", maxlength: 255 }],
                success: function (result) {
                    if (result == "OK") {
                        let remarks = $('input[name=txtDeletedRemarks]').val();
                        if (remarks !== undefined) {
                            $('#loader').show();
                            let Postapiurl = localStorage.getItem('baseUrl') + "air/Markups/DeleteWingMarkup"
                            let Postheaderss = new Headers();
                            Postheaderss.append("Authorization", 'Bearer ' + localStorage.getItem('token'));
                            Postheaderss.append("OrgId", localStorage.getItem('currentOrganisation'));
                            Postheaderss.append("Content-Type", "application/json; charset=utf-8");
                            var formdata = JSON.stringify({
                                "Id": e.getAttribute("data-delete-id"),
                                "Remarks": remarks,
                            });
                            fetch(Postapiurl, {
                                method: "POST",
                                headers: Postheaderss,
                                body: formdata,
                                redirect: 'follow'

                            }).then(response => {
                                if (response.ok) {
                                    return response.json();
                                } else {
                                    throw new Error(response.statusText);
                                }
                            }).then(data => {

                                if (data.messageType == 1) {
                                    $('#loader').hide();

                                    messageBox("success", "Deleted successfully");
                                    $("#loadGridData").trigger('click');

                                }
                                else {
                                    $('#loader').hide();
                                    messageBox("error", data.message);
                                }
                            }).catch((error) => {
                                $('#loader').hide();
                                messageBox("error", error.message);
                            });
                        }

                    }
                    return false;
                }
            });


        }


    </script>
}
        

